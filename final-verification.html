<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERIFICACI√ìN FINAL - Estado Real de Firestore</title>
    <style>
        body { font-family: 'Courier New', monospace; margin: 20px; background: #000; color: #00ff00; }
        .container { max-width: 1200px; margin: 0 auto; background: #111; padding: 20px; border-radius: 10px; border: 2px solid #00ff00; }
        .result { padding: 10px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #00ff00; background: #222; font-size: 12px; }
        .error { border-left-color: #ff4444; color: #ff4444; }
        .warning { border-left-color: #ffaa00; color: #ffaa00; }
        .success { border-left-color: #00ff00; color: #00ff00; }
        button { padding: 15px 25px; background: #333; color: #00ff00; border: 1px solid #555; border-radius: 6px; cursor: pointer; margin: 10px 5px; font-family: 'Courier New'; }
        button:hover { background: #555; }
        .fix-btn { background: #ff0000; color: white; font-weight: bold; }
        .code { background: #000; padding: 15px; border-radius: 4px; font-family: 'Courier New'; font-size: 11px; overflow-x: auto; white-space: pre; border: 1px solid #333; max-height: 300px; overflow-y: auto; }
        h1 { color: #00ff00; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç VERIFICACI√ìN FINAL DEL ESTADO REAL</h1>
        <p>Error persiste: "configDoc.exists is not a function" - Verificando estado actual de Firestore</p>
        
        <button onclick="checkEverything()">üìä VERIFICAR TODO EL ESTADO</button>
        <button onclick="fixUserCredits()" class="fix-btn">üîß FIJAR CR√âDITOS USUARIO</button>
        <button onclick="fixGlobalPremium()" class="fix-btn">üåê FIJAR PREMIUM GLOBAL</button>
        <button onclick="testFunctionNow()">üß™ PROBAR FUNCI√ìN AHORA</button>
        
        <div id="results"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-functions-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDWy1rFkFRB_MX8NxQdCVPWCQZKIlEqHM8",
            authDomain: "brain-storm-8f0d8.firebaseapp.com",
            projectId: "brain-storm-8f0d8",
            storageBucket: "brain-storm-8f0d8.appspot.com",
            messagingSenderId: "659020802774",
            appId: "1:659020802774:web:ab0ee5c3b2e7f5e3b70ed1"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            console.log(message);
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                addResult(`‚úÖ Usuario: ${user.email} (${user.uid})`, 'success');
                checkEverything();
            } else {
                auth.signInWithEmailAndPassword('w.guillermoef@gmail.com', 'Willywonka1900')
                    .then(() => addResult('‚úÖ Login exitoso', 'success'))
                    .catch((error) => addResult(`‚ùå Error login: ${error.message}`, 'error'));
            }
        });

        async function checkEverything() {
            try {
                const user = auth.currentUser;
                if (!user) return;

                addResult('üîç VERIFICANDO ESTADO REAL DE FIRESTORE...', 'warning');

                // 1. Usuario actual
                const userDoc = await db.collection('users').doc(user.uid).get();
                addResult(`<div class="code">
=== USUARIO ACTUAL ===
UID: ${user.uid}
Email: ${user.email}
Documento existe: ${userDoc.exists}

${userDoc.exists ? `Datos del usuario:
${JSON.stringify(userDoc.data(), null, 2)}` : 'DOCUMENTO NO EXISTE'}
</div>`, userDoc.exists ? 'success' : 'error');

                // 2. Configuraci√≥n global
                const configDoc = await db.collection('config').doc('app').get();
                addResult(`<div class="code">
=== CONFIGURACI√ìN GLOBAL ===
Documento config/app existe: ${configDoc.exists}

${configDoc.exists ? `Configuraci√≥n global:
${JSON.stringify(configDoc.data(), null, 2)}` : 'DOCUMENTO NO EXISTE'}
</div>`, configDoc.exists ? 'success' : 'error');

                // 3. An√°lisis del problema
                if (!userDoc.exists) {
                    addResult('‚ùå PROBLEMA: Usuario no existe en Firestore', 'error');
                } else {
                    const userData = userDoc.data();
                    const hasCredits = userData.generationCredits > 0;
                    const isPremium = userData.isPremium;
                    
                    addResult(`üìä ACCESO INDIVIDUAL: Cr√©ditos=${userData.generationCredits}, Premium=${isPremium}, Acceso=${hasCredits || isPremium}`, hasCredits || isPremium ? 'success' : 'warning');
                }

                if (!configDoc.exists) {
                    addResult('‚ùå PROBLEMA: Configuraci√≥n global no existe', 'error');
                } else {
                    const configData = configDoc.data();
                    const isGlobalActive = configData.isPremiumGlobalActive;
                    addResult(`üìä ACCESO GLOBAL: Premium Global=${isGlobalActive}`, isGlobalActive ? 'success' : 'warning');
                }

                // 4. Determinar acci√≥n necesaria
                const needsUserFix = !userDoc.exists || (userDoc.exists && userDoc.data().generationCredits === 0 && !userDoc.data().isPremium);
                const needsGlobalFix = !configDoc.exists || (configDoc.exists && !configDoc.data().isPremiumGlobalActive);

                if (needsUserFix && needsGlobalFix) {
                    addResult('üö® ACCI√ìN NECESARIA: Fijar tanto usuario como configuraci√≥n global', 'error');
                } else if (needsUserFix) {
                    addResult('üö® ACCI√ìN NECESARIA: Fijar cr√©ditos del usuario', 'warning');
                } else if (needsGlobalFix) {
                    addResult('üö® ACCI√ìN NECESARIA: Fijar premium global', 'warning');
                } else {
                    addResult('‚úÖ TODO DEBER√çA ESTAR FUNCIONANDO', 'success');
                }

            } catch (error) {
                addResult(`‚ùå Error verificando estado: ${error.message}`, 'error');
            }
        }

        async function fixUserCredits() {
            try {
                const user = auth.currentUser;
                addResult('üîß FIJANDO CR√âDITOS DEL USUARIO...', 'warning');

                const userData = {
                    email: user.email,
                    displayName: user.displayName || 'Usuario',
                    generationCredits: 999,
                    isPremium: true,
                    premiumUntil: new Date(Date.now() + (365 * 24 * 60 * 60 * 1000)),
                    createdAt: firebase.firestore.Timestamp.now(),
                    lastGenerationDate: null,
                    photoURL: user.photoURL || null,
                    premiumSource: 'manual_fix',
                    fixedAt: firebase.firestore.Timestamp.now()
                };

                await db.collection('users').doc(user.uid).set(userData);
                addResult('‚úÖ Usuario fijado con 999 cr√©ditos y premium activo', 'success');

                setTimeout(checkEverything, 1000);

            } catch (error) {
                addResult(`‚ùå Error fijando usuario: ${error.message}`, 'error');
            }
        }

        async function fixGlobalPremium() {
            try {
                addResult('üåê FIJANDO PREMIUM GLOBAL...', 'warning');

                const globalConfig = {
                    isPremiumGlobalActive: true,
                    promoEndDate: new Date(Date.now() + (365 * 24 * 60 * 60 * 1000)),
                    promoDescription: 'Premium Global - Fix Final',
                    allowAllSocialNetworks: true,
                    allowAllCopyTypes: true,
                    unlimitedGenerations: true,
                    bypassCreditsCheck: true,
                    lastUpdated: firebase.firestore.Timestamp.now(),
                    updatedBy: auth.currentUser.email,
                    finalFix: true
                };

                await db.collection('config').doc('app').set(globalConfig);
                addResult('‚úÖ Premium global fijado y activo', 'success');

                setTimeout(checkEverything, 1000);

            } catch (error) {
                addResult(`‚ùå Error fijando premium global: ${error.message}`, 'error');
            }
        }

        async function testFunctionNow() {
            try {
                addResult('üß™ PROBANDO FUNCI√ìN CON FIX DE SINTAXIS...', 'warning');

                const apiFunction = functions.httpsCallable('api');
                const testData = {
                    generationMode: 'copywriting',
                    socialMedia: ['Facebook'],
                    keyword: 'test final fix',
                    copyType: 'Narrativo o storytelling',
                    language: 'es'
                };

                const result = await apiFunction(testData);
                addResult('‚úÖ ¬°FUNCI√ìN FUNCION√ì CORRECTAMENTE!', 'success');
                addResult(`<div class="code">Resultado: ${JSON.stringify(result.data, null, 2)}</div>`, 'success');

            } catch (error) {
                addResult(`‚ùå Error en funci√≥n: ${error.message}`, 'error');
                
                if (error.message.includes('cr√©ditos disponibles')) {
                    addResult('üö® A√∫n hay problemas con la validaci√≥n de cr√©ditos', 'error');
                } else if (error.message.includes('exists is not a function')) {
                    addResult('üö® A√∫n hay problemas de sintaxis en el c√≥digo', 'error');
                } else {
                    addResult('‚ÑπÔ∏è Error diferente - puede ser progreso', 'warning');
                }
            }
        }
    </script>
</body>
</html>
