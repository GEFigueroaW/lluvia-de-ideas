<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEBUG ESPEC√çFICO - Error Cr√©ditos</title>
    <style>
        body { font-family: 'Courier New', monospace; margin: 20px; background: #000; color: #00ff00; }
        .container { max-width: 1200px; margin: 0 auto; background: #111; padding: 20px; border-radius: 10px; border: 1px solid #333; }
        .result { padding: 10px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #00ff00; background: #222; }
        .error { border-left-color: #ff4444; color: #ff4444; }
        .warning { border-left-color: #ffaa00; color: #ffaa00; }
        .info { border-left-color: #4444ff; color: #4444ff; }
        .success { border-left-color: #00ff00; color: #00ff00; }
        button { padding: 12px 24px; background: #333; color: #00ff00; border: 1px solid #555; border-radius: 6px; cursor: pointer; margin: 10px 5px; font-family: 'Courier New'; }
        button:hover { background: #555; }
        .emergency { background: #ff4444; color: white; }
        .code { background: #000; padding: 15px; border-radius: 4px; font-family: 'Courier New'; font-size: 12px; overflow-x: auto; white-space: pre; border: 1px solid #333; }
        h1, h2, h3 { color: #00ff00; }
        .step { background: #333; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç DEBUG ESPEC√çFICO - ERROR DE CR√âDITOS</h1>
        <p>An√°lisis l√≠nea por l√≠nea de por qu√© sigue arrojando el error de cr√©ditos.</p>
        
        <div class="step">
            <h3>PASO 1: Verificar datos exactos del usuario</h3>
            <button onclick="debugUserData()">üìä Debug Datos Usuario</button>
        </div>
        
        <div class="step">
            <h3>PASO 2: Verificar configuraci√≥n premium global</h3>
            <button onclick="debugGlobalPremium()">üåê Debug Premium Global</button>
        </div>
        
        <div class="step">
            <h3>PASO 3: Simular la l√≥gica exacta de la Cloud Function</h3>
            <button onclick="simulateCloudFunctionLogic()">‚öôÔ∏è Simular L√≥gica Funci√≥n</button>
        </div>
        
        <div class="step">
            <h3>PASO 4: Activar premium inmediatamente</h3>
            <button onclick="emergencyActivatePremium()" class="emergency">üö® ACTIVAR PREMIUM AHORA</button>
        </div>
        
        <div class="step">
            <h3>PASO 5: Test de generaci√≥n real</h3>
            <button onclick="testRealGeneration()">üß™ Test Generaci√≥n Real</button>
        </div>
        
        <div class="step">
            <h3>PASO 6: Ejecutar funci√≥n de debug autom√°tica</h3>
            <button onclick="runDebugFunction()" class="emergency">ü§ñ DEBUG AUTOM√ÅTICO</button>
        </div>
        
        <div id="results"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-functions-compat.js"></script>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDWy1rFkFRB_MX8NxQdCVPWCQZKIlEqHM8",
            authDomain: "brain-storm-8f0d8.firebaseapp.com",
            projectId: "brain-storm-8f0d8",
            storageBucket: "brain-storm-8f0d8.appspot.com",
            messagingSenderId: "659020802774",
            appId: "1:659020802774:web:ab0ee5c3b2e7f5e3b70ed1"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            console.log(message);
        }

        // Autenticaci√≥n autom√°tica
        auth.onAuthStateChanged((user) => {
            if (user) {
                addResult(`‚úÖ Usuario autenticado: ${user.email} (UID: ${user.uid})`, 'success');
                debugUserData();
            } else {
                auth.signInWithEmailAndPassword('w.guillermoef@gmail.com', 'Willywonka1900')
                    .then(() => {
                        addResult('‚úÖ Login autom√°tico exitoso', 'success');
                    })
                    .catch((error) => {
                        addResult(`‚ùå Error en login: ${error.message}`, 'error');
                    });
            }
        });

        async function debugUserData() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    addResult('‚ùå No hay usuario autenticado', 'error');
                    return;
                }

                addResult('=== PASO 1: DATOS EXACTOS DEL USUARIO ===', 'info');
                
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    addResult('‚ùå PROBLEMA ENCONTRADO: El documento del usuario NO EXISTE', 'error');
                    addResult('üîß Esto significa que se crear√° autom√°ticamente con 5 cr√©ditos', 'warning');
                    return;
                }

                const userData = userDoc.data();
                
                addResult(`<div class="code">
DATOS EXACTOS DEL USUARIO:
========================
UID: ${user.uid}
Email: ${user.email}
generationCredits: ${userData.generationCredits} (tipo: ${typeof userData.generationCredits})
isPremium: ${userData.isPremium} (tipo: ${typeof userData.isPremium})
lastGenerationDate: ${userData.lastGenerationDate}
createdAt: ${userData.createdAt}

L√ìGICA DE VERIFICACI√ìN:
======================
userData.generationCredits > 0: ${userData.generationCredits > 0}
userData.isPremium: ${userData.isPremium}
hasAccess (individual): ${userData.generationCredits > 0 || userData.isPremium}
</div>`, 'info');

                // Verificar si tiene acceso individual
                const hasIndividualAccess = userData.generationCredits > 0 || userData.isPremium;
                if (hasIndividualAccess) {
                    addResult('‚úÖ TIENE ACCESO INDIVIDUAL', 'success');
                } else {
                    addResult('‚ùå NO TIENE ACCESO INDIVIDUAL - Verificando premium global...', 'warning');
                    await debugGlobalPremium();
                }

            } catch (error) {
                addResult(`‚ùå Error verificando datos usuario: ${error.message}`, 'error');
            }
        }

        async function debugGlobalPremium() {
            try {
                addResult('=== PASO 2: CONFIGURACI√ìN PREMIUM GLOBAL ===', 'info');
                
                const configDoc = await db.collection('config').doc('app').get();
                
                if (!configDoc.exists()) {
                    addResult('‚ùå PROBLEMA CR√çTICO: No existe config/app en Firestore', 'error');
                    addResult('üîß Esto significa que NO hay premium global configurado', 'warning');
                    return;
                }

                const configData = configDoc.data();
                
                addResult(`<div class="code">
CONFIGURACI√ìN PREMIUM GLOBAL:
============================
isPremiumGlobalActive: ${configData.isPremiumGlobalActive} (tipo: ${typeof configData.isPremiumGlobalActive})
promoEndDate: ${configData.promoEndDate}
promoDescription: ${configData.promoDescription}
allowAllSocialNetworks: ${configData.allowAllSocialNetworks}
unlimitedGenerations: ${configData.unlimitedGenerations}

VERIFICACI√ìN DE FECHA:
=====================
Fecha actual: ${new Date()}
Fecha fin promo: ${configData.promoEndDate ? configData.promoEndDate.toDate() : 'No definida'}
¬øPromo vigente?: ${!configData.promoEndDate || configData.promoEndDate.toDate() > new Date()}
</div>`, 'info');

                // Simular l√≥gica exacta
                if (configData.isPremiumGlobalActive) {
                    const promoEndDate = configData.promoEndDate;
                    if (!promoEndDate || promoEndDate.toDate() > new Date()) {
                        addResult('‚úÖ PREMIUM GLOBAL EST√Å ACTIVO Y VIGENTE', 'success');
                    } else {
                        addResult('‚ùå PREMIUM GLOBAL EXPIRADO', 'error');
                    }
                } else {
                    addResult('‚ùå PREMIUM GLOBAL NO EST√Å ACTIVO', 'error');
                }

            } catch (error) {
                addResult(`‚ùå Error verificando premium global: ${error.message}`, 'error');
            }
        }

        async function simulateCloudFunctionLogic() {
            try {
                addResult('=== PASO 3: SIMULACI√ìN EXACTA DE LA CLOUD FUNCTION ===', 'info');
                
                const user = auth.currentUser;
                const userDoc = await db.collection('users').doc(user.uid).get();
                let userData = userDoc.exists ? userDoc.data() : null;

                // Simular creaci√≥n autom√°tica si no existe
                if (!userDoc.exists) {
                    addResult('üîß Usuario no existe, simulando creaci√≥n autom√°tica...', 'warning');
                    userData = {
                        generationCredits: 5,
                        isPremium: false
                    };
                }

                // L√ìGICA EXACTA DE LA CLOUD FUNCTION
                let hasAccess = userData.generationCredits > 0 || userData.isPremium;
                let accessReason = '';

                addResult(`<div class="code">
SIMULACI√ìN L√çNEA POR L√çNEA:
===========================
1. hasAccess inicial = userData.generationCredits > 0 || userData.isPremium
   hasAccess = ${userData.generationCredits} > 0 || ${userData.isPremium}
   hasAccess = ${hasAccess}

2. Si (!hasAccess) verificar premium global...
</div>`, 'info');

                if (!hasAccess) {
                    addResult('‚ö†Ô∏è Sin acceso individual, verificando premium global...', 'warning');
                    
                    try {
                        const configDoc = await db.collection('config').doc('app').get();
                        if (configDoc.exists()) {
                            const configData = configDoc.data();
                            const isGlobalPremiumActive = configData.isPremiumGlobalActive;
                            
                            addResult(`<div class="code">
3. Verificaci√≥n premium global:
   configDoc.exists() = ${configDoc.exists()}
   isGlobalPremiumActive = ${isGlobalPremiumActive}
</div>`, 'info');
                            
                            if (isGlobalPremiumActive) {
                                const promoEndDate = configData.promoEndDate;
                                const isPromoValid = !promoEndDate || promoEndDate.toDate() > new Date();
                                
                                addResult(`<div class="code">
4. Verificaci√≥n fecha promoci√≥n:
   promoEndDate = ${promoEndDate}
   isPromoValid = ${isPromoValid}
</div>`, 'info');
                                
                                if (isPromoValid) {
                                    hasAccess = true;
                                    accessReason = 'Premium Global Activo';
                                    addResult('‚úÖ ACCESO CONCEDIDO POR PREMIUM GLOBAL', 'success');
                                } else {
                                    addResult('‚ùå PREMIUM GLOBAL EXPIRADO', 'error');
                                }
                            } else {
                                addResult('‚ùå PREMIUM GLOBAL NO ACTIVO', 'error');
                            }
                        } else {
                            addResult('‚ùå NO EXISTE CONFIGURACI√ìN GLOBAL', 'error');
                        }
                    } catch (error) {
                        addResult(`‚ùå Error en verificaci√≥n global: ${error.message}`, 'error');
                    }
                } else {
                    accessReason = userData.isPremium ? 'Premium Individual' : userData.generationCredits + ' cr√©ditos';
                    addResult('‚úÖ ACCESO CONCEDIDO POR ACCESO INDIVIDUAL', 'success');
                }

                addResult(`<div class="code">
RESULTADO FINAL:
===============
hasAccess = ${hasAccess}
accessReason = ${accessReason}

if (!hasAccess) {
    throw Error('No tienes cr√©ditos disponibles...')
}
</div>`, hasAccess ? 'success' : 'error');

                if (!hasAccess) {
                    addResult('‚ùå LA FUNCI√ìN ARROJAR√çA EL ERROR AQU√ç', 'error');
                } else {
                    addResult('‚úÖ LA FUNCI√ìN DEBER√çA FUNCIONAR CORRECTAMENTE', 'success');
                }

            } catch (error) {
                addResult(`‚ùå Error en simulaci√≥n: ${error.message}`, 'error');
            }
        }

        async function emergencyActivatePremium() {
            try {
                addResult('=== PASO 4: ACTIVACI√ìN DE EMERGENCIA ===', 'warning');
                
                const user = auth.currentUser;
                
                // 1. Activar premium individual
                addResult('üîß Activando premium individual...', 'info');
                await db.collection('users').doc(user.uid).update({
                    isPremium: true,
                    generationCredits: 9999,
                    premiumUntil: new Date(Date.now() + (365 * 24 * 60 * 60 * 1000)),
                    premiumSource: 'emergency_debug',
                    premiumUpdatedAt: firebase.firestore.Timestamp.now()
                });
                
                // 2. Activar premium global
                addResult('üîß Activando premium global...', 'info');
                const globalConfig = {
                    isPremiumGlobalActive: true,
                    promoEndDate: new Date(Date.now() + (365 * 24 * 60 * 60 * 1000)),
                    promoDescription: 'Premium Global de Emergencia - Debug Session',
                    allowAllSocialNetworks: true,
                    allowAllCopyTypes: true,
                    unlimitedGenerations: true,
                    bypassCreditsCheck: true,
                    lastUpdated: firebase.firestore.Timestamp.now(),
                    updatedBy: user.email
                };
                
                await db.collection('config').doc('app').set(globalConfig, { merge: true });
                
                addResult('‚úÖ PREMIUM INDIVIDUAL Y GLOBAL ACTIVADOS', 'success');
                addResult('üîÑ Verificando cambios...', 'info');
                
                // Verificar inmediatamente
                setTimeout(() => {
                    debugUserData();
                    debugGlobalPremium();
                }, 2000);
                
            } catch (error) {
                addResult(`‚ùå Error en activaci√≥n de emergencia: ${error.message}`, 'error');
            }
        }

        async function testRealGeneration() {
            try {
                addResult('=== PASO 5: TEST DE GENERACI√ìN REAL ===', 'info');
                
                const apiFunction = functions.httpsCallable('api');
                
                const testData = {
                    generationMode: 'copywriting',
                    socialMedia: ['Facebook'],
                    keyword: 'test debug',
                    copyType: 'Narrativo o storytelling',
                    language: 'es'
                };
                
                addResult('üß™ Llamando a la Cloud Function con datos de test...', 'info');
                addResult(`<div class="code">Datos enviados: ${JSON.stringify(testData, null, 2)}</div>`, 'info');
                
                const result = await apiFunction(testData);
                
                addResult('‚úÖ GENERACI√ìN EXITOSA!', 'success');
                addResult(`<div class="code">Resultado: ${JSON.stringify(result.data, null, 2)}</div>`, 'success');
                
            } catch (error) {
                addResult(`‚ùå ERROR EN GENERACI√ìN REAL: ${error.message}`, 'error');
                addResult(`<div class="code">Error completo: ${JSON.stringify(error, null, 2)}</div>`, 'error');
                
                // Si el error sigue siendo de cr√©ditos, hay un problema m√°s profundo
                if (error.message.includes('cr√©ditos disponibles')) {
                    addResult('üö® EL ERROR PERSISTE - PROBLEMA M√ÅS PROFUNDO', 'error');
                    addResult('üîß Posibles causas:', 'warning');
                    addResult('- La funci√≥n no se despleg√≥ correctamente', 'warning');
                    addResult('- Hay cache en la Cloud Function', 'warning');
                    addResult('- Error en el c√≥digo de la funci√≥n', 'warning');
                }
            }
        }

        async function runDebugFunction() {
            try {
                addResult('=== PASO 6: DEBUG AUTOM√ÅTICO ===', 'info');
                
                const debugFunction = functions.httpsCallable('debugCreditsError');
                
                addResult('ü§ñ Ejecutando funci√≥n de debug autom√°tica...', 'info');
                
                const result = await debugFunction();
                
                addResult('‚úÖ DEBUG AUTOM√ÅTICO COMPLETADO', 'success');
                
                const debugInfo = result.data.debugInfo;
                
                addResult(`<div class="code">
RESULTADOS DEL DEBUG AUTOM√ÅTICO:
===============================

PASO 1 - Documento Usuario:
- Existe: ${debugInfo.step1_userDoc.exists}
- Funci√≥n data(): ${debugInfo.step1_userDoc.hasDataFunction}

PASO 2 - Acceso Individual:
${debugInfo.step2_individualAccess ? `
- Cr√©ditos: ${debugInfo.step2_individualAccess.generationCredits} (${debugInfo.step2_individualAccess.generationCreditsType})
- Tiene cr√©ditos: ${debugInfo.step2_individualAccess.hasCredits}
- Es premium: ${debugInfo.step2_individualAccess.isPremium} (${debugInfo.step2_individualAccess.isPremiumType})
- Acceso individual: ${debugInfo.step2_individualAccess.hasIndividualAccess}
` : 'No disponible (usuario no existe)'}

PASO 3 - Configuraci√≥n Global:
- Config existe: ${debugInfo.step3_globalConfig.configExists}
- Funci√≥n data(): ${debugInfo.step3_globalConfig.hasDataFunction}
${debugInfo.step3_globalConfig.verification ? `
- Premium global activo: ${debugInfo.step3_globalConfig.verification.isGlobalPremiumActive}
- Fecha fin: ${debugInfo.step3_globalConfig.verification.promoEndDate}
- Fecha actual: ${debugInfo.step3_globalConfig.verification.currentDate}
- Promo v√°lida: ${debugInfo.step3_globalConfig.verification.isPromoValid}
- Acceso global: ${debugInfo.step3_globalConfig.verification.hasGlobalAccess}
` : ''}

PASO 4 - Verificaci√≥n Final:
- Acceso individual: ${debugInfo.step4_finalVerification.individualAccess}
- Acceso global: ${debugInfo.step4_finalVerification.hasGlobalAccess}
- Acceso final: ${debugInfo.step4_finalVerification.finalAccess}
- ¬øArrojar√≠a error?: ${debugInfo.step4_finalVerification.wouldThrowError}

${debugInfo.step5_autoActivation ? `
PASO 5 - Auto-activaci√≥n:
- Premium activado autom√°ticamente ‚úÖ
- Cr√©ditos asignados: ${debugInfo.step5_autoActivation.userDataUpdated.generationCredits}
- Premium individual: ${debugInfo.step5_autoActivation.userDataUpdated.isPremium}
- Premium global: ${debugInfo.step5_autoActivation.globalConfigUpdated.isPremiumGlobalActive}
` : ''}
</div>`, 'info');

                // Mostrar recomendaciones
                result.data.recommendations.forEach(rec => {
                    addResult(`üí° ${rec}`, 'success');
                });
                
                if (debugInfo.step5_autoActivation) {
                    addResult('üöÄ PREMIUM ACTIVADO - PRUEBA GENERAR COPYWRITING AHORA', 'success');
                }
                
            } catch (error) {
                addResult(`‚ùå Error en debug autom√°tico: ${error.message}`, 'error');
                addResult(`<div class="code">Error completo: ${JSON.stringify(error, null, 2)}</div>`, 'error');
            }
        }
    </script>
</body>
</html>
